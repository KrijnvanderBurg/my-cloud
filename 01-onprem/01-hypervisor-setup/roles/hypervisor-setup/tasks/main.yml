---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  changed_when: false
  failed_when: false

- name: Install KVM and libvirt packages
  ansible.builtin.apt:
    name: "{{ kvm_packages }}"
    state: present

- name: Start and enable libvirtd service
  ansible.builtin.service:
    name: libvirtd
    state: started
    enabled: true

- name: Add current user to libvirt group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: libvirt
    append: true
  when: ansible_user_id != "root"

- name: Start default storage pool
  ansible.builtin.command: virsh pool-start {{ pool_name }}
  register: pool_start
  changed_when: pool_start.rc == 0
  failed_when: false

- name: Enable storage pool autostart
  ansible.builtin.command: virsh pool-autostart {{ pool_name }}
  changed_when: false

- name: Start default network
  ansible.builtin.command: virsh net-start {{ network_name }}
  register: net_start
  changed_when: net_start.rc == 0
  failed_when: false

- name: Enable network autostart
  ansible.builtin.command: virsh net-autostart {{ network_name }}
  changed_when: false

