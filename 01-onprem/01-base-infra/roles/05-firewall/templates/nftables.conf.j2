#!/usr/sbin/nft -f
# {{ ansible_managed }}
# Base nftables firewall rules

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow loopback
    iif lo accept

    # Allow established/related connections
    ct state established,related accept

    # Allow ICMP
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    # Allowed TCP ports
{% for port in firewall_allowed_tcp_ports %}
    tcp dport {{ port }} accept
{% endfor %}

    # Allowed UDP ports
{% for port in firewall_allowed_udp_ports %}
    udp dport {{ port }} accept
{% endfor %}

{% if firewall_log_dropped %}
    # Log dropped packets
    log prefix "nftables-dropped: " counter drop
{% else %}
    counter drop
{% endif %}
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
