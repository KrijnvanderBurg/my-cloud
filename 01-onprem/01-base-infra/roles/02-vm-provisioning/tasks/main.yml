---
# --- Download cloud image ---
- name: Download Ubuntu cloud image
  ansible.builtin.get_url:
    url: "{{ cloud_image_url }}"
    dest: "{{ libvirt_pool_path | default(vm_image_cache_dir) }}/{{ cloud_image_name }}"
    mode: "0644"
    timeout: 300
  tags: [provision]

# --- Get list of existing VMs for idempotency ---
- name: List existing VMs
  community.libvirt.virt:
    command: list_vms
  register: _existing_vms
  tags: [provision]

# --- Create each VM ---
- name: Provision VM
  ansible.builtin.include_tasks: create_vm.yml
  loop: "{{ groups['vms'] }}"
  loop_control:
    loop_var: _current_vm
  tags: [provision]

# --- Wait for SSH on all VMs ---
- name: Wait for SSH on VMs
  ansible.builtin.wait_for:
    host: "{{ hostvars[item]['ansible_host'] }}"
    port: 22
    delay: 10
    timeout: 300
  loop: "{{ groups['vms'] }}"
  loop_control:
    label: "{{ item }}"
  tags: [provision]
