---
# ==============================================================================
# Harden base VMs (connects as admin user â€” fully idempotent)
# ==============================================================================
- name: Harden base VMs
  hosts: base_vms
  gather_facts: true
  become: true
  serial: "30%"
  max_fail_percentage: 10
  tags:
    - hardening
  vars:
    _deployer: "{{ lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true) }}"
    vm_keys_dir: "{{ vm_keys_base_dir }}/{{ _deployer }}/.ssh/vm-keys-{{ env }}"
    ansible_user: "{{ admin_user }}"
    ansible_ssh_private_key_file: "{{ vm_keys_dir }}/{{ inventory_hostname }}_id_ed25519"

  pre_tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command:
        cmd: cloud-init status --wait
      register: cloud_init_result
      changed_when: false
      failed_when: cloud_init_result.rc not in [0, 2]
      timeout: 300

    - name: Remove root SSH authorized keys (defense-in-depth)
      ansible.builtin.file:
        path: /root/.ssh/authorized_keys
        state: absent

    - name: Display hardening information
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Hardening: {{ inventory_hostname }}"
          - "=========================================="
          - "IP: {{ ansible_host }}"
          - "User: {{ admin_user }}"
          - "=========================================="

  roles:
    - role: ssh-hardening
      tags: ['ssh-hardening']
    - role: os-hardening
      tags: ['os-hardening']
    - role: fail2ban
      tags: ['fail2ban']

  post_tasks:
    - name: Display hardening summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Hardening Complete: {{ inventory_hostname }}"
          - "=========================================="
          - "SSH: ssh -i {{ vm_keys_dir }}/{{ inventory_hostname }}_id_ed25519 {{ admin_user }}@{{ ansible_host }}"
          - ""
          - "Applied:"
          - "  - SSH hardening (CIS/STIG-aligned, root login disabled)"
          - "  - OS hardening (kernel, filesystem, users)"
          - "  - Firewall (UFW, deny-all ingress + egress)"
          - "  - Fail2ban (SSH brute-force + recidive)"
          - "  - AIDE file integrity monitoring"
          - "  - Automatic security updates"
          - "  - Audit logging (CIS rules)"
          - "  - Root account locked"
          - "=========================================="
