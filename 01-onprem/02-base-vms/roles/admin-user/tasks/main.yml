---
# Administrative user management tasks

- name: Set VM-specific SSH key path
  ansible.builtin.set_fact:
    vm_ssh_key: "{{ vm_keys_dir }}/{{ inventory_hostname }}_id_ed25519"
  tags:
    - admin-user

- name: Display SSH key being used for this VM
  ansible.builtin.debug:
    msg: "Using permanent SSH key: {{ vm_ssh_key }}"
  tags:
    - admin-user

- name: Create administrative user
  ansible.builtin.user:
    name: "{{ admin_user }}"
    groups: "{{ admin_user_groups }}"
    append: true
    shell: /bin/bash
    create_home: true
    state: present
  tags:
    - admin-user

- name: Set up SSH directory for administrative user
  ansible.builtin.file:
    path: "/home/{{ admin_user }}/.ssh"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0700'
  tags:
    - admin-user

- name: Read VM-specific public key from hypervisor
  ansible.builtin.slurp:
    src: "{{ vm_ssh_key }}.pub"
  register: vm_public_key
  delegate_to: localhost
  become: false
  tags:
    - admin-user

- name: Deploy VM-specific SSH key to administrative user
  ansible.builtin.copy:
    dest: "/home/{{ admin_user }}/.ssh/authorized_keys"
    content: "{{ vm_public_key.content | b64decode }}"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0600'
  tags:
    - admin-user

- name: Configure passwordless sudo for administrative user
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ admin_user }}"
    content: "{{ admin_user }} ALL=(ALL) NOPASSWD:ALL\n"
    mode: '0440'
    validate: '/usr/sbin/visudo -cf %s'
  tags:
    - admin-user

- name: Test SSH connection with administrative user
  ansible.builtin.wait_for:
    port: 22
    host: "{{ ansible_host }}"
    timeout: 10
  delegate_to: localhost
  become: false
  tags:
    - admin-user

- name: Display administrative user setup complete
  ansible.builtin.debug:
    msg:
      - "Administrative user '{{ admin_user }}' created successfully"
      - "SSH access configured with VM-specific key"
      - "Test access: ssh -i {{ vm_ssh_key }} {{ admin_user }}@{{ ansible_host }}"
  tags:
    - admin-user
