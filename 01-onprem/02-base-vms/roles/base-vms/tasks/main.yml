---
# Base VMs provisioning tasks
# Derives VM list from inventory group 'base_vms' â€” single source of truth.
# Adding a VM: add one entry to inventories/<env>/hosts.yml, then run this playbook.

# ============================================================================
# Phase 1: Prepare dependencies
# ============================================================================

- name: Determine actual user running deployment
  ansible.builtin.set_fact:
    actual_user: "{{ lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true) }}"
  tags:
    - always

- name: Set permanent SSH key directory path
  ansible.builtin.set_fact:
    vm_keys_dir: "{{ vm_keys_base_dir }}/{{ actual_user }}/.ssh/vm-keys-{{ env }}"
  tags:
    - always

- name: Set target VMs from inventory (override with -e target_vms)
  ansible.builtin.set_fact:
    provision_vms: "{{ target_vms | default(groups['base_vms']) }}"
  tags:
    - always

- name: Download Ubuntu cloud image
  ansible.builtin.get_url:
    url: "{{ cloud_image_url }}"
    dest: "{{ base_image_path }}"
    checksum: "{{ ('sha256:' + cloud_image_checksum) if cloud_image_checksum | default('') | length > 0 else omit }}"
    mode: "0644"
    timeout: 300
  tags:
    - provision

- name: Create permanent SSH keys directory
  ansible.builtin.file:
    path: "{{ vm_keys_dir }}"
    state: directory
    mode: "0700"
    owner: "{{ actual_user }}"
    group: "{{ actual_user }}"
  become: false
  tags:
    - provision

- name: Generate per-VM permanent SSH keypairs
  community.crypto.openssh_keypair:
    path: "{{ vm_keys_dir }}/{{ item }}_id_ed25519"
    type: ed25519
    comment: "{{ admin_user }}@{{ item }}"
    mode: '0600'
    state: present
    force: false
    owner: "{{ actual_user }}"
    group: "{{ actual_user }}"
  loop: "{{ provision_vms }}"
  become: false
  tags:
    - provision

# ============================================================================
# Phase 2: Create VM disk images and cloud-init configs
# ============================================================================

- name: Create VM disk images from base cloud image
  ansible.builtin.copy:
    src: "{{ base_image_path }}"
    dest: "{{ vm_images_path }}/{{ item }}.qcow2"
    remote_src: true
    force: false
  loop: "{{ provision_vms }}"
  register: vm_disk_copy
  tags:
    - provision

- name: Resize VM disk images to {{ vm_disk_gb }}G
  ansible.builtin.command:
    cmd: "qemu-img resize {{ vm_images_path }}/{{ item.item }}.qcow2 {{ vm_disk_gb }}G"
  loop: "{{ vm_disk_copy.results }}"
  when: item.changed
  loop_control:
    label: "{{ item.item }}"
  tags:
    - provision

- name: Create cloud-init user-data
  ansible.builtin.copy:
    dest: "{{ vm_images_path }}/{{ item }}-user-data.yml"
    mode: '0600'
    content: |
      #cloud-config
      hostname: {{ item }}
      manage_etc_hosts: true
      timezone: UTC

      users:
        - name: {{ admin_user }}
          groups: {{ admin_user_groups | join(',') }}
          shell: /bin/bash
          sudo: ALL=(ALL) NOPASSWD:ALL
          lock_passwd: true
          ssh_authorized_keys:
            - {{ lookup('file', vm_keys_dir + '/' + item + '_id_ed25519.pub') }}

      # Security: no root SSH, no password auth, unique host keys
      disable_root: true
      ssh_pwauth: false
      ssh_deletekeys: true
      ssh_genkeytypes: ['ed25519', 'rsa']

      packages:
        - qemu-guest-agent

      runcmd:
        - systemctl enable --now qemu-guest-agent

      growpart:
        mode: auto
        devices: ['/']
  loop: "{{ provision_vms }}"
  tags:
    - provision

- name: Create cloud-init meta-data
  ansible.builtin.copy:
    dest: "{{ vm_images_path }}/{{ item }}-meta-data.yml"
    mode: '0644'
    content: |
      instance-id: {{ item }}
      local-hostname: {{ item }}
  loop: "{{ provision_vms }}"
  tags:
    - provision

- name: Create cloud-init network-config
  ansible.builtin.copy:
    dest: "{{ vm_images_path }}/{{ item }}-network-config.yml"
    mode: '0644'
    content: |
      version: 2
      ethernets:
        enp1s0:
          dhcp4: false
          addresses:
            - {{ hostvars[item]['ansible_host'] }}/24
          routes:
            - to: default
              via: {{ network_gateway }}
          nameservers:
            addresses:
              - {{ network_dns }}
  loop: "{{ provision_vms }}"
  tags:
    - provision

# ============================================================================
# Phase 3: Provision VMs
# ============================================================================

- name: Check if VM already exists
  ansible.builtin.command:
    cmd: "virsh dominfo {{ item }}"
  register: vm_exists
  failed_when: false
  changed_when: false
  loop: "{{ provision_vms }}"
  tags:
    - provision

- name: Provision VMs with virt-install
  ansible.builtin.command:
    cmd: >
      virt-install
      --name {{ item.item }}
      --memory {{ hostvars[item.item]['vm_memory_mb'] | default(vm_memory_mb) }}
      --vcpus {{ hostvars[item.item]['vm_vcpus'] | default(vm_vcpus) }}
      --disk {{ vm_images_path }}/{{ item.item }}.qcow2,device=disk,bus=virtio
      --import
      --os-variant {{ vm_os_variant }}
      --network network={{ libvirt_network }},model=virtio
      --graphics none
      --console pty,target_type=serial
      --cloud-init user-data={{ vm_images_path }}/{{ item.item }}-user-data.yml,meta-data={{ vm_images_path }}/{{ item.item }}-meta-data.yml,network-config={{ vm_images_path }}/{{ item.item }}-network-config.yml
      --noautoconsole
  loop: "{{ vm_exists.results }}"
  when: item.rc != 0
  loop_control:
    label: "{{ item.item }}"
  tags:
    - provision

- name: Ensure VMs are started
  community.libvirt.virt:
    name: "{{ item }}"
    state: running
  loop: "{{ provision_vms }}"
  tags:
    - provision

- name: Enable VM autostart
  community.libvirt.virt:
    name: "{{ item }}"
    autostart: true
  loop: "{{ provision_vms }}"
  tags:
    - provision

- name: Wait for VMs to be accessible via SSH
  ansible.builtin.wait_for:
    host: "{{ hostvars[item]['ansible_host'] }}"
    port: 22
    delay: 10
    timeout: 180
  loop: "{{ provision_vms }}"
  tags:
    - provision

# ============================================================================
# Phase 4: Display results
# ============================================================================

- name: Display VM provisioning summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "VM Provisioned: {{ item }}"
      - "=========================================="
      - "IP: {{ hostvars[item]['ansible_host'] }}"
      - "Disk: {{ vm_disk_gb }}G"
      - "SSH: ssh -i {{ vm_keys_dir }}/{{ item }}_id_ed25519 {{ admin_user }}@{{ hostvars[item]['ansible_host'] }}"
      - "=========================================="
  loop: "{{ provision_vms }}"
  tags:
    - provision
