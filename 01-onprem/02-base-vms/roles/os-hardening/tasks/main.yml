---
# Operating system hardening tasks

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - os-hardening

- name: Install security packages
  ansible.builtin.apt:
    name:
      - ufw
      - unattended-upgrades
      - apt-listchanges
      - auditd
      - audispd-plugins
      - aide
      - aide-common
    state: present
  tags:
    - os-hardening

# ==============================================================================
# Unattended upgrades
# ==============================================================================

- name: Configure unattended upgrades
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}ESMApps:${distro_codename}-apps-security";
          "${distro_id}ESM:${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "{{ unattended_upgrades_automatic_reboot | lower }}";
    mode: '0644'
  tags:
    - os-hardening

- name: Enable unattended upgrades
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
    mode: '0644'
  tags:
    - os-hardening

# ==============================================================================
# Firewall (UFW) â€” deny-all ingress AND egress, explicit allowlisting
# ==============================================================================

- name: Set UFW default incoming policy to deny
  community.general.ufw:
    direction: incoming
    policy: deny
  tags:
    - os-hardening
    - firewall

- name: Set UFW default outgoing policy to deny
  community.general.ufw:
    direction: outgoing
    policy: deny
  tags:
    - os-hardening
    - firewall

- name: Configure UFW ingress rules
  community.general.ufw:
    rule: "{{ item.rule }}"
    direction: in
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default(omit) }}"
    comment: "{{ item.comment | default(omit) }}"
  loop: "{{ ufw_rules }}"
  tags:
    - os-hardening
    - firewall

- name: Configure UFW egress rules
  community.general.ufw:
    rule: "{{ item.rule }}"
    direction: out
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default(omit) }}"
    comment: "{{ item.comment | default(omit) }}"
  loop: "{{ ufw_egress_rules }}"
  tags:
    - os-hardening
    - firewall

- name: Enable UFW
  community.general.ufw:
    state: enabled
  tags:
    - os-hardening
    - firewall

# ==============================================================================
# Login banners
# ==============================================================================

- name: Deploy login banner to /etc/issue
  ansible.builtin.copy:
    dest: /etc/issue
    content: "{{ login_banner }}"
    mode: '0644'
  tags:
    - os-hardening

- name: Deploy SSH login banner to /etc/issue.net
  ansible.builtin.copy:
    dest: /etc/issue.net
    content: "{{ login_banner }}"
    mode: '0644'
  tags:
    - os-hardening

- name: Configure SSH to display banner
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/issue.net'
    state: present
  notify: restart sshd
  tags:
    - os-hardening

# ==============================================================================
# Kernel module blacklisting (USB storage, firewire, thunderbolt)
# ==============================================================================

- name: Blacklist insecure kernel modules
  ansible.builtin.copy:
    dest: /etc/modprobe.d/hardening-blacklist.conf
    content: |
      {% for mod in blacklist_kernel_modules %}
      blacklist {{ mod }}
      install {{ mod }} /bin/false
      {% endfor %}
    mode: '0644'
  tags:
    - os-hardening

# ==============================================================================
# Audit rules (CIS-aligned)
# ==============================================================================

- name: Deploy CIS-aligned audit rules
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/hardening.rules
    content: |
      # CIS-aligned audit rules

      # Monitor user/group modifications
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity

      # Monitor sudo configuration
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers

      # Monitor SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd_config
      -w /etc/ssh/sshd_config.d/ -p wa -k sshd_config

      # Monitor login events
      -w /var/log/auth.log -p wa -k auth_log
      -w /var/log/faillog -p wa -k login_events
      -w /var/log/lastlog -p wa -k login_events

      # Monitor file permission changes
      -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
      -a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod

      # Monitor kernel module loading
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules
      -a always,exit -F arch=b64 -S init_module,finit_module,delete_module -k modules

      # Monitor time changes
      -a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -k time_change
      -w /etc/localtime -p wa -k time_change

      # Make audit configuration immutable (must be last rule)
      -e 2
    mode: '0640'
  notify: restart auditd
  tags:
    - os-hardening

# ==============================================================================
# AIDE file integrity monitoring
# ==============================================================================

- name: Check if AIDE database exists
  ansible.builtin.stat:
    path: /var/lib/aide/aide.db
  register: aide_db
  tags:
    - os-hardening

- name: Initialize AIDE database
  ansible.builtin.command:
    cmd: aideinit
  when: not aide_db.stat.exists
  changed_when: true
  tags:
    - os-hardening

- name: Configure daily AIDE check cron job
  ansible.builtin.cron:
    name: "AIDE daily integrity check"
    hour: "4"
    minute: "30"
    job: "/usr/bin/aide --check --config /etc/aide/aide.conf > /var/log/aide-check.log 2>&1"
    user: root
  tags:
    - os-hardening

# ==============================================================================
# Apply devsec.hardening OS hardening
# ==============================================================================

- name: Apply OS hardening with devsec.hardening
  ansible.builtin.include_role:
    name: devsec.hardening.os_hardening
  tags:
    - os-hardening

# ==============================================================================
# Service management
# ==============================================================================

- name: Ensure auditd service is enabled and started
  ansible.builtin.service:
    name: auditd
    state: started
    enabled: true
  tags:
    - os-hardening

- name: Check root account lock status
  ansible.builtin.command:
    cmd: passwd -S root
  register: root_status
  changed_when: false
  tags:
    - os-hardening

- name: Lock root account password
  ansible.builtin.command:
    cmd: passwd -l root
  when: root_status.stdout.split()[1] != 'L'
  changed_when: true
  tags:
    - os-hardening

- name: Display OS hardening summary
  ansible.builtin.debug:
    msg:
      - "OS hardening complete:"
      - "  - Automatic security updates: enabled"
      - "  - UFW firewall: deny incoming + deny outgoing (allowlisted)"
      - "  - Fail2ban: installed (see fail2ban role)"
      - "  - AIDE file integrity monitoring: initialized"
      - "  - Audit daemon: enabled with CIS rules"
      - "  - Login banners: deployed"
      - "  - Kernel modules: USB/firewire/thunderbolt blacklisted"
      - "  - Root password: locked"
      - "  - Kernel hardening: applied"
      - "  - File permissions: hardened"
  tags:
    - os-hardening
