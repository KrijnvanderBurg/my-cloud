name: Ansible Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths: ['01-onprem/**']
  push:
    branches: [main]
    paths: ['01-onprem/**']

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ansible-operations
  cancel-in-progress: false

jobs:
  # ===== Hypervisor Setup =====
  op-hypervisor-setup-dev:
    name: op-hypervisor-setup-dev
    uses: ./.github/workflows/ansible-deployment-template.yml
    with:
      working_directory: ./01-onprem/01-hypervisor-setup
      inventory: inventories/dev
      artifact_name: op-hypervisor-setup-dev
      environment: dev
    secrets: inherit

  # ===== Base VMs =====
  op-base-vms-dev:
    name: op-base-vms-dev
    needs: [op-hypervisor-setup-dev]
    uses: ./.github/workflows/ansible-deployment-template.yml
    with:
      working_directory: ./01-onprem/02-base-vms
      inventory: inventories/dev
      artifact_name: op-base-vms-dev
      environment: dev
    secrets: inherit

  # ===== OpenClaw =====
  op-openclaw-dev:
    name: op-openclaw-dev
    needs: [op-base-vms-dev]
    uses: ./.github/workflows/ansible-deployment-template.yml
    with:
      working_directory: ./01-onprem/03-openclaw
      inventory: inventories/dev
      artifact_name: op-openclaw-dev
      environment: dev
    secrets: inherit
