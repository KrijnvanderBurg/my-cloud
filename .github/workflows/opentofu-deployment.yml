name: OpenTofu Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: opentofu-operations
  cancel-in-progress: false

jobs:
  # ===== Platform Management (dev) =====
  deploy-management-dev:
    name: ğŸ”§ Management (dev)
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./01-platform-management/environments/dev
      artifact_name: pl-management-dev
      state_key: pl-management-dev.tfstate
      client_id: bcba6fb0-afb6-4e1b-9517-dd7ffb35c2c6 # sp-platform-management-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate

  # ===== Platform Identity (dev) =====
  deploy-identity-dev:
    name: ğŸ”‘ Identity (dev)
    needs: [deploy-management-dev]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./02-platform-identity/environments/dev
      artifact_name: pl-identity-dev
      state_key: pl-identity-dev.tfstate
      client_id: 2972657a-4e99-44c6-80f8-1e265595c81b # sp-platform-identity-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate

  # ===== Platform Connectivity West Europe (dev) =====
  deploy-connectivity-weu-dev:
    name: ğŸŒ Connectivity WEU (dev)
    needs: [deploy-identity-dev]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./03-platform-connectivity/environments/dev-weu
      artifact_name: pl-connectivity-dev-weu
      state_key: pl-connectivity-dev-weu.tfstate
      client_id: 869a0c27-8210-4f91-8a16-80082b8462fd # sp-platform-connectivity-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate

  # ===== Platform Connectivity Germany West Central (dev) =====
  deploy-connectivity-gwc-dev:
    name: ğŸŒ Connectivity GWC (dev)
    needs: [deploy-connectivity-weu-dev]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./03-platform-connectivity/environments/dev-gwc
      artifact_name: pl-connectivity-dev-gwc
      state_key: pl-connectivity-dev-gwc.tfstate
      client_id: 869a0c27-8210-4f91-8a16-80082b8462fd # sp-platform-connectivity-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate

  # ===== Platform Connectivity Global (dev) =====
  deploy-connectivity-glb-dev:
    name: ğŸŒ Connectivity GLB (dev)
    needs: [deploy-connectivity-gwc-dev]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./03-platform-connectivity/environments/dev-glb
      artifact_name: pl-connectivity-dev-glb
      state_key: pl-connectivity-dev-glb.tfstate
      client_id: 869a0c27-8210-4f91-8a16-80082b8462fd # sp-platform-connectivity-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate

  # ===== Platform Landing Zone - Drives (dev) =====
  deploy-drives-dev:
    name: ğŸš€ Landing Zone Drives (dev)
    needs: [deploy-connectivity-glb-dev]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/opentofu-deployment-stage.yml
    with:
      working_directory: ./04-platform-landing-zones/environments/drives-dev
      artifact_name: plz-drives-dev
      state_key: plz-drives-dev.tfstate
      client_id: e8716cc9-4c26-4f93-9feb-0860aedfe0e7 # sp-plz-drives-on-dev-na-01
      environment: dev
      state_storage_account: sttfstatecodevgwc01
      state_resource_group: rg-tfstate-co-dev-gwc-01
      state_container: tfstate
